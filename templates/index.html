<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>博客测试系统（Token&Session严格分离）</title>
    <style>
        .container { width: 80%; margin: 20px auto; }
        .form-group { margin: 15px 0; }
        label { display: inline-block; width: 100px; }
        input, textarea { width: 300px; padding: 5px; }
        button { padding: 6px 15px; margin-right: 10px; cursor: pointer; }
        #msg { color: red; margin: 10px 0; }
        .success { color: green !important; }
        .article-item { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .article-id { font-weight: bold; color: #0066cc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>博客测试系统（Token&Session严格分离）</h1>

        <!-- 登录区域 -->
        <div id="login-area">
            <h2>1. 登录</h2>
            <div class="form-group">
                <label>用户名：</label>
                <input type="text" id="username" placeholder="admin/test">
            </div>
            <div class="form-group">
                <label>密码：</label>
                <input type="password" id="password" placeholder="Admin@123456/Test@123456">
            </div>
            <button onclick="login()">登录</button>
            <button onclick="logout()" disabled id="logout-btn">登出</button>
            <div id="msg"></div>
        </div>

        <!-- 文章操作区域（登录后显示） -->
        <div id="article-area" style="display: none;">
            <!-- 2. 发布文章 -->
            <h2>2. 发布文章（返回article_id）</h2>
            <div class="form-group">
                <label>标题：</label>
                <input type="text" id="art-title" placeholder="至少2个字符">
            </div>
            <div class="form-group">
                <label>内容：</label>
                <textarea id="art-content" rows="5" placeholder="至少5个字符"></textarea>
            </div>
            <button onclick="createArticle()">发布文章</button>
            <div id="create-result" class="form-group"></div>

            <!-- 3. 查询文章列表 -->
            <h2>3. 查询我的文章（含article_id）</h2>
            <button onclick="listArticles()">查询文章</button>
            <div id="article-list" class="form-group"></div>

            <!-- 4. 修改文章 -->
            <h2>4. 修改文章（需输入article_id）</h2>
            <div class="form-group">
                <label>article_id：</label>
                <input type="number" id="update-id" placeholder="从查询结果复制ID">
            </div>
            <div class="form-group">
                <label>新标题：</label>
                <input type="text" id="update-title" placeholder="留空则不修改">
            </div>
            <div class="form-group">
                <label>新内容：</label>
                <textarea id="update-content" rows="3" placeholder="留空则不修改"></textarea>
            </div>
            <button onclick="updateArticle()">修改文章</button>
            <div id="update-result" class="form-group"></div>

            <!-- 5. 删除文章 -->
            <h2>5. 删除文章（需输入article_id）</h2>
            <div class="form-group">
                <label>article_id：</label>
                <input type="number" id="delete-id" placeholder="从查询结果复制ID">
            </div>
            <button onclick="deleteArticle()">删除文章</button>
            <div id="delete-result" class="form-group"></div>
        </div>
    </div>

    <script>
        let token = "";  // Token仅存内存，用于请求头传递（身份认证）
        let lastArticleId = "";  // 记录最新发布的article_id

        // 1. 登录：仅获取Token（内存），Session ID由浏览器自动存Cookie
        function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            fetch("/api/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",  // 仅用于携带Session Cookie（会话保持）
                body: JSON.stringify({ username, password })
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    token = data.data.token;  // Token存入内存，不碰Cookie
                    document.getElementById("msg").className = "success";
                    document.getElementById("msg").innerText = "登录成功！Token仅存内存，Cookie仅含Session ID";
                    document.getElementById("article-area").style.display = "block";
                    document.getElementById("logout-btn").disabled = false;
                } else {
                    document.getElementById("msg").className = "";
                    document.getElementById("msg").innerText = data.msg;
                }
            })
            .catch(err => {
                document.getElementById("msg").innerText = "登录失败：" + err;
            });
        }

        // 新增：登出（主动失效Session，Token由前端自行清空）
        function logout() {
            if (!token) {
                document.getElementById("msg").innerText = "未登录，无需登出";
                return;
            }
            fetch("/api/logout", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token  // Token用于身份认证
                },
                credentials: "include"  // 携带Session Cookie
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    token = "";  // 前端清空Token
                    document.getElementById("msg").className = "success";
                    document.getElementById("msg").innerText = "登出成功！Session已失效，Token已清空";
                    document.getElementById("article-area").style.display = "none";
                    document.getElementById("logout-btn").disabled = true;
                    // 清空所有输入框
                    document.getElementById("update-id").value = "";
                    document.getElementById("delete-id").value = "";
                } else {
                    document.getElementById("msg").className = "";
                    document.getElementById("msg").innerText = data.msg;
                }
            });
        }

        // 2. 发布文章：Token（请求头）+ Session（Cookie）双重传递
        function createArticle() {
            const title = document.getElementById("art-title").value;
            const content = document.getElementById("art-content").value;

            fetch("/api/article/create", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token  // Token仅此处传递
                },
                credentials: "include",  // Session Cookie自动携带
                body: JSON.stringify({ title, content })
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    lastArticleId = data.data.article_id;
                    document.getElementById("create-result").className = "success";
                    document.getElementById("create-result").innerText =
                        `发布成功！article_id=${lastArticleId}，已填充到修改/删除框`;
                    document.getElementById("update-id").value = lastArticleId;
                    document.getElementById("delete-id").value = lastArticleId;
                    document.getElementById("art-title").value = "";
                    document.getElementById("art-content").value = "";
                } else {
                    document.getElementById("create-result").className = "";
                    document.getElementById("create-result").innerText = data.msg;
                }
            });
        }

        // 3. 查询文章列表：同上
        function listArticles() {
            fetch("/api/article/list", {
                method: "GET",
                headers: { "Authorization": "Bearer " + token },
                credentials: "include"
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    let html = `<div>共${data.data.count}篇文章：</div>`;
                    data.data.articles.forEach(art => {
                        html += `<div class="article-item">
                            article_id：<span class="article-id">${art.id}</span><br>
                            标题：${art.title}<br>
                            创建时间：${art.create_time}
                        </div>`;
                    });
                    document.getElementById("article-list").innerHTML = html;
                } else {
                    document.getElementById("article-list").innerText = data.msg;
                }
            });
        }

        // 4. 修改文章：同上
        function updateArticle() {
            const article_id = document.getElementById("update-id").value;
            const title = document.getElementById("update-title").value;
            const content = document.getElementById("update-content").value;

            fetch("/api/article/update", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                credentials: "include",
                body: JSON.stringify({ article_id, title, content })
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    document.getElementById("update-result").className = "success";
                    document.getElementById("update-result").innerText =
                        `修改成功！article_id=${data.data.article_id}`;
                    listArticles();
                } else {
                    document.getElementById("update-result").className = "";
                    document.getElementById("update-result").innerText = data.msg;
                }
            });
        }

        // 5. 删除文章：同上
        function deleteArticle() {
            const article_id = document.getElementById("delete-id").value;

            fetch("/api/article/delete", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                credentials: "include",
                body: JSON.stringify({ article_id })
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    document.getElementById("delete-result").className = "success";
                    document.getElementById("delete-result").innerText =
                        `删除成功！article_id=${data.data.article_id}`;
                    listArticles();
                    document.getElementById("delete-id").value = "";
                } else {
                    document.getElementById("delete-result").className = "";
                    document.getElementById("delete-result").innerText = data.msg;
                }
            });
        }
    </script>
</body>
</html>